#
# This is the makefile for the python related programs
#
# Make sure you have defined $PYTHON as this directory first
# then type
#   ./configure
# 	make install
#
# if this fails, consult https://github.com/agnwinds/python/wiki/Installing-Python
# for manual install.

CMAKE = mpicc
NVCC = nvcc
GSL = $(PYTHON)/software/gsl-2.6
CUNIT = $(PYTHON)/software/cunit-2.1-3
LIBS = True

MAKE_SOURCE = cd $(PYTHON)/source; make CC=$(CMAKE) INDENT=no python; make CC=$(CMAKE) INDENT=no py_wind; make CC=$(CMAKE) INDENT=no windsave2table
CHECK_SOURCE = cd $(PYTHON)/tests; make check CC=$(CMAKE) NVCC=$(NVCC)

ifeq (True, $(LIBS))
	# GNU Science Library -- math routines
	INSTALL_GSL = cd $(GSL); ./configure --disable-shared --prefix=$(GSL) CC=gcc CCP=ccp; make -i; make check 2>&1; make -i install; make clean;
	INSTALL_GSL_NOCHECK = cd $(GSL); ./configure --disable-shared --prefix=$(GSL) CC=gcc CCP=ccp; make -i; make -i install; make clean;
	MOVE_GSL = mkdir $(PYTHON)/include/gsl/; mv $(GSL)/include/gsl/* $(PYTHON)/include/gsl; mv $(GSL)/lib/lib* $(PYTHON)/lib/;

	# CUnit -- unit test framework
	INSTALL_CUNIT = cd $(CUNIT); autoreconf -vif; ./configure --disable-shared --prefix=$(CUNIT); make; make check; make install; make clean
	INSTALL_CUNIT = cd $(CUNIT); autoreconf -vif; ./configure --disable-shared --prefix=$(CUNIT); make; make install; make clean
	MOVE_CUNIT = mv $(CUNIT)/include/CUnit $(PYTHON)/include; mv $(CUNIT)/lib/lib* $(PYTHON)/lib/
else
	INSTALL_GSL =
	INSTALL_GSL_NO_CHECK =
	MOVE_GSL =

	INSTALL_CUNIT =
	INSTALL_CUNIT_NO_CHECK =
	MOVE_CUNIT =
endif

# install for travis
gh_workflow_install:
	@echo 'Installing Python. the radiative transfer code'
	@echo 'Installing in directory '$(PYTHON)

	# Then make GSL library
	@echo 'Installing GSL library...'
	$(INSTALL_GSL_NOCHECK)
	$(MOVE_GSL)

	# Then make CUnit Library
	$(INSTALL_CUNIT_NO_CHECK)
	$(MOVE_CUNIT)

	#finally, make the latest release
	@echo 'Making source code...'
	$(MAKE_SOURCE)
	@echo 'all done'


install:
	@echo 'Installing Python. the radiative transfer code'
	@echo 'Installing in directory '$(PYTHON)

	# Then make GSL library
	@echo 'Installing GSL library...'
	# $(INSTALL_GSL)
	# $(MOVE_GSL)

	# Now make the unit test framework
	@echo 'Installing CUnit...'
	# $(INSTALL_CUNIT)
	# $(MOVE_CUNIT)

	# Finally, make the latest release
	@echo 'Making source code...'
	$(MAKE_SOURCE)
	$(CHECK_SOURCE)
	@echo 'all done'

clean:
	rm -f *.o *~
	cd $(GSL); make clean;
	cd $(CUNIT); make clean
	cd $(PYTHON)/source/; make clean

# runs a more rigorous clean in gsl
distclean:
	rm -f *.o *~
	cd $(GSL); make distclean
	cd $(CUNIT); make distclean
	cd $(PYTHON)/source/; make clean

# actually removes the compiled libraries
rm_lib:
	rm -rf $(PYTHON)/include/gsl
	rm -rf $(PYTHON)/include/CUnit
	rm -f $(PYTHON)/lib/lib*
