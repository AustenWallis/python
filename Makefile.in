#
# This is the Makefile for the python related programs
#
# Make sure you have defined $PYTHON as this directory first
# then type:
#
#   ./configure [--with-cuda]
# 	make install
#
# If this fails, consult https://github.com/agnwinds/python/wiki/Installing-Python
# for manual install.

CMAKE = mpicc
GSL_LOCATION = $(PYTHON)/software/gsl-2.6
CUNIT_LOCATION = $(PYTHON)/software/cunit-3.2.7
INSTALL_LIBS = True

MAKE_SOURCE = cd $(PYTHON)/source; make CC=$(CMAKE) INDENT=no all

ifeq (True, $(INSTALL_LIBS))
	# GNU Science Library -- math routines
	INSTALL_GSL = cd $(GSL_LOCATION); ./configure --disable-shared --prefix=$(GSL_LOCATION) CC=gcc CCP=ccp; make -i; make check 2>&1; make -i install; make clean;
	INSTALL_GSL_NOCHECK = cd $(GSL_LOCATION); ./configure --disable-shared --prefix=$(GSL_LOCATION) CC=gcc CCP=ccp; make -i; make -i install; make clean;
	MOVE_GSL = mkdir $(PYTHON)/include/gsl/; mv $(GSL_LOCATION)/include/gsl/* $(PYTHON)/include/gsl; mv $(GSL_LOCATION)/lib/lib* $(PYTHON)/lib/;

	# CUnit -- unit test framework: built using CMake, so only build if installed
	ifneq ($(shell which cmake), )
		INSTALL_CUNIT = \
			mkdir -p $(PYTHON)/include/CUnit; \
			cd $(CUNIT_LOCATION); \
			mkdir -p build; \
			cd build; \
			cmake ..; \
			cmake --build .; \
			mv CUnit/libcunit.a $(PYTHON)/lib; \
			cp ../CUnit/CUnit/*.h $(PYTHON)/include/CUnit/; \
			cd ..; \
			rm -r build;
		MAKE_CHECK = \
			cd $(PYTHON)/source; \
			make check CC=$(CMAKE)
	else
		@echo 'CMake is not installed, will not try build CUnit'
		INSTALL_CUNIT =
		MAKE_CHECK =
	endif
else
	INSTALL_GSL =
	INSTALL_GSL_NO_CHECK =
	MOVE_GSL =
	INSTALL_CUNIT =
endif

# install for travis
gh_workflow_install:
	@echo 'Installing Python. the radiative transfer code'
	@echo 'Installing in directory '$(PYTHON)

	# Then make GSL library
	@echo 'Installing GSL library...'
	$(INSTALL_GSL_NOCHECK)
	$(MOVE_GSL)

	# Then make CUnit Library
	@echo 'Installing CUnit library...'
	$(INSTALL_CUNIT)

	#finally, make the latest release
	@echo 'Making source code...'
	$(MAKE_SOURCE)
	$(MAKE_CHECK)
	@echo 'all done'

install:
	@echo 'Installing Python. the radiative transfer code'
	@echo 'Installing in directory '$(PYTHON)

	# Then make GSL library
	@echo 'Installing GSL library...'
	$(INSTALL_GSL)
	$(MOVE_GSL)

	# Now make the unit test framework
	@echo 'Installing CUnit library...'
	$(INSTALL_CUNIT)

	# Finally, make the latest release
	@echo 'Making source code...'
	$(MAKE_SOURCE)
	$(MAKE_CHECK)
	@echo 'all done'

# Run the regular clean for the libraries and Python. CUnit doesn't need this,
# as we delete the CMake build directory after installing it
clean:
	rm -f *.o *~
	cd $(GSL_LOCATION); make clean;
	cd $(PYTHON)/source/; make clean

# Runs a more rigorous clean for the libraries and Python. CUnit doesn't need
# this, as we delete the CMake build directory after installing it
distclean:
	rm -f *.o *~
	cd $(GSL_LOCATION); make distclean
	cd $(PYTHON)/source/; make clean

# Remove just the libraries
rm_lib:
	rm -rf $(PYTHON)/include/gsl
	rm -rf $(PYTHON)/include/CUnit
	rm -f $(PYTHON)/lib/lib*
